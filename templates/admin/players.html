<!DOCTYPE html>
<html lang="ru">

<head>
    <title>S.P.F. Base — Управление игроками</title>

    {% include 'partials/base_header.html' %}

    <link rel="stylesheet" href="{{ 'admin.css' | ver }}">
</head>

<body>
    <div class="page-background" style="background-image: url('/static/images/wallpaper.jpeg');">
        {% include 'partials/header.html' %}

        <div class="content-tile">
            <h2>Управление игроками</h2>

            <div class="toolbar">
                <button onclick="loadPlayers()">Обновить список</button>
                <button onclick="createPlayer()">Создать игрока</button>
            </div>

            <table class="players-table" id="players-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Discord</th>
                        <th>Steam</th>
                        <th>Имя</th>
                        <th>МБ использовано</th>
                        <th>Чёрные списки</th>
                        <th>Заметки</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const api = "/api/player_control";
        const token = localStorage.getItem("access_token"); 

        async function loadPlayers() {
            const res = await fetch(`${api}/get`, { headers: { Authorization: "Bearer " + token } });
            if (!res.ok) { alert("Ошибка загрузки"); return; }
            const data = await res.json();
            const tbody = document.querySelector("#players-table tbody");
            tbody.innerHTML = "";

            for (const p of data) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.discord_id || "-"}</td>
            <td>${p.steam_id || "-"}</td>
            <td>${p.data.discord_name || "-"}</td>
            <td>${p.data.mb_taken} / ${p.data.mb_limit}</td>
            <td>
                админ: ${p.data.blacklist.admin ? "да" : "нет"}<br>
                лор: ${p.data.blacklist.lore ? "да" : "нет"}
            </td>
            <td>${p.data.note.length}</td>
            <td>
                <button onclick="editPlayer(${p.id})">Редактировать</button>
                <button onclick="addNote(${p.id})">Заметка</button>
            </td>
        `;
                tbody.appendChild(tr);
            }
        }

        async function createPlayer() {
            const discord_name = prompt("Discord имя (поиск по серверу):");
            if (!discord_name) return;
            const steam_url = prompt("Steam ID / URL:");
            if (!steam_url) return;

            const res = await fetch(`${api}/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                body: JSON.stringify({ discord_name, steam_url })
            });
            if (res.ok) loadPlayers();
            else alert(await res.text());
        }

        async function editPlayer(id) {
            const mb_limit = prompt("Новый лимит (можно +10 или -5):");
            if (mb_limit === null) return;
            const mb_taken = prompt("Изменить использованное место (+10, -5, =20):");
            const res = await fetch(`${api}/edit`, {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                body: JSON.stringify({ u_id: id, mb_limit, mb_taken })
            });
            if (res.ok) loadPlayers();
            else alert(await res.text());
        }

        async function addNote(id) {
            const text = prompt("Текст заметки:");
            if (!text) return;
            const res = await fetch(`${api}/note/add`, {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                body: JSON.stringify({ u_id: id, text })
            });
            if (res.ok) loadPlayers();
            else alert(await res.text());
        }

        loadPlayers();
    </script>
</body>

</html>