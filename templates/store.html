<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Донат услуги</title>

    <meta property="og:title" content="S.P.F. Base store" />
    <meta property="og:description" content="Страница донат услуг проекта S.P.F." />

    {% include 'partials/base_header.html' %}

    <link rel="stylesheet" href="{{ 'store.css' | ver }}" />
</head>

<body>
    <div class="page-background" style="background-image: url('/static/images/wallpaper.jpeg');">
        {% include 'partials/header.html' %}

        <div class="content-tile store-wrap">
            <div class="store-filters">
                <div class="store-search">
                    <input type="text" id="store-search" placeholder="Поиск по названию..." />
                </div>
            </div>

            {% macro section(sec_id, title, items) %}
            <section id="{{ sec_id }}" class="store-section" aria-labelledby="{{ sec_id }}-title">
                <h2 class="category-title" id="{{ sec_id }}-title">{{ title }}</h2>

                {% for store in items %}
                <article class="store-item" role="button" tabindex="0" aria-expanded="false"
                    data-id="{{ store.u_id }}" data-timeend="{{ store.discount_time_end }}">
                    <header class="store-header">
                        <div class="store-title-wrap">
                            <h3 class="store-title">{{ store.name }}</h3>
                            <div class="store-badges">
                                {% if store.discount_value > 0 %}
                                <span class="badge badge-discount">-{{ store.discount_value }}%</span>
                                {% endif %}
                                {% if store.oferta_limit %}
                                <span class="badge badge-limit">Оферта-лимит</span>
                                {% endif %}
                                {% if store.status == 'off' %}
                                <span class="badge badge-muted" title="Услуга выключена">Неактивна</span>
                                {% elif store.left is not none and store.left <= 0 %} <span class="badge badge-muted"
                                    title="Нет остатка">Нет в наличии</span>
                                    {% elif store.status == 'archive' %}
                                    <span class="badge badge-muted" title="Архивная услуга">Архив</span>
                                    {% endif %}
                            </div>
                        </div>
                    </header>

                    <div class="store-meta" id="meta-{{ store.u_id }}">
                        {% if store.oferta_limit %}
                        <div class="meta-inline-group oferta-limit-note" role="note" aria-label="Offer limit notice">
                            <span class="meta-label">Примечание:</span>
                            <span class="meta-value">
                                Услуга помечена как оферта-лимит: <a href="/wiki/docs/oferta#3-условия-оказания-услуг"
                                    target="_blank" rel="noopener">см. оферту п. 3.5</a>.
                            </span>
                        </div>
                        {% endif %}

                        <div class="meta-label">Описание:</div>
                        <div class="meta-value">{{ store.description }}</div>

                        <div class="meta-inline-group">
                            <span class="meta-label">Цена:</span>
                            <span class="meta-value">
                                {% if store.discount_value > 0 %}
                                <span class="original-price">{{ store.price_main }}₽</span>
                                <span class="discounted-price">{{ store.final_price }}₽</span>
                                {% else %}
                                {{ store.price_main }}₽
                                {% endif %}
                            </span>
                        </div>

                        {% if store.left is not none %}
                        <div class="meta-inline-group">
                            <span class="meta-label">Осталось:</span>
                            <span class="meta-value">{{ store.left }}</span>
                        </div>
                        {% endif %}

                        {% if store.discount_value > 0 %}
                        <div class="meta-inline-group">
                            <span class="meta-label">Скидка действует ещё:</span>
                            <span class="meta-value time-left">—</span>
                        </div>
                        {% endif %}

                        <div class="meta-actions">
                            <button class="copy-button" type="button"
                                aria-label="Скопировать код услуги">Скопировать</button>
                        </div>
                    </div>
                </article>
                {% endfor %}
            </section>
            {% endmacro %}

            <div class="store-list">
                {{ section('active-list', 'Активные', active_list) }}
                {{ section('inactive-list', 'Неактивные', inactive_list) }}
                {{ section('archived-list', 'Архивные', archived_list) }}

                <p id="no-services-message" class="is-hidden">Нет доступных услуг</p>
            </div>

            <footer class="store-footer">
                <a href="/wiki/docs/oferta" target="_blank" rel="noopener">Ознакомиться с офертой</a>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.getElementById("store-search");
            const sections = [
                { wrap: document.getElementById("active-list"), title: document.getElementById("active-list-title") },
                { wrap: document.getElementById("inactive-list"), title: document.getElementById("inactive-list-title") },
                { wrap: document.getElementById("archived-list"), title: document.getElementById("archived-list-title") },
            ];
            const noServicesMessage = document.getElementById("no-services-message");
            const items = Array.from(document.querySelectorAll(".store-item"));

            function setHidden(el, hide) {
                el.classList.toggle("is-hidden", !!hide);
            }

            function updateSectionVisibility() {
                let totalVisible = 0;

                sections.forEach(({ wrap, title }) => {
                    if (!wrap) return;
                    const visibleInSection = Array.from(wrap.querySelectorAll(".store-item"))
                        .filter(it => it.style.display !== "none").length;

                    totalVisible += visibleInSection;
                    setHidden(title, visibleInSection === 0);
                    setHidden(wrap, visibleInSection === 0);
                });

                setHidden(noServicesMessage, totalVisible > 0);
            }

            items.forEach(item => {
                const toggle = () => {
                    const meta = item.querySelector(".store-meta");
                    if (!meta) return;
                    meta.classList.toggle("visible");
                    item.setAttribute("aria-expanded", meta.classList.contains("visible") ? "true" : "false");
                };
                item.addEventListener("click", toggle);
                item.addEventListener("keydown", e => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        toggle();
                    }
                });
            });

            searchInput.addEventListener("input", () => {
                const value = (searchInput.value || "").toLowerCase();
                items.forEach(item => {
                    const name = item.querySelector(".store-title")?.textContent.toLowerCase() || "";
                    const visible = name.includes(value);
                    item.style.display = visible ? "block" : "none";
                });
                updateSectionVisibility();
            });

            function updateTimers() {
                const now = Date.now();
                items.forEach(item => {
                    const timeStr = item.getAttribute("data-timeend");
                    if (!timeStr) return;
                    const end = new Date(timeStr);
                    if (isNaN(end)) return;

                    const diff = end.getTime() - now;
                    const display = item.querySelector(".time-left");
                    if (!display) return;

                    if (diff <= 0) {
                        display.textContent = "Скидка закончилась";
                        return;
                    }

                    const days = Math.floor(diff / 86400000);
                    const hours = Math.floor((diff % 86400000) / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);

                    let text = "";
                    if (days > 0) text += `${days}д `;
                    if (hours > 0 || days > 0) text += `${hours}ч `;
                    text += `${minutes}м ${seconds}с`;
                    display.textContent = text;
                });
            }
            updateTimers();
            setInterval(updateTimers, 1000);

            document.querySelectorAll(".copy-button").forEach(button => {
                button.addEventListener("click", e => {
                    e.stopPropagation();
                    const item = button.closest(".store-item");
                    if (!item) return;
                    const id = item.getAttribute("data-id");
                    const text = `\`service_${id}\``;
                    navigator.clipboard.writeText(text).then(() => {
                        button.textContent = "Скопировано!";
                        setTimeout(() => button.textContent = "Скопировать", 1500);
                    }).catch(() => {
                        button.textContent = "Ошибка";
                        setTimeout(() => button.textContent = "Скопировать", 1500);
                    });
                });
            });

            items.forEach(item => {
                const leftoverGroup = Array.from(item.querySelectorAll(".meta-inline-group")).find(group => {
                    const label = group.querySelector(".meta-label");
                    return label && label.textContent.trim() === "Осталось:";
                });
                if (!leftoverGroup) return;

                const valueElem = leftoverGroup.querySelector(".meta-value");
                if (!valueElem) return;

                const count = parseInt((valueElem.textContent || "").trim(), 10);
                if (isNaN(count)) return;

                valueElem.classList.remove("limit-low", "limit-medium", "limit-high");
                if (count <= 4) valueElem.classList.add("limit-low");
                else if (count <= 10) valueElem.classList.add("limit-medium");
                else valueElem.classList.add("limit-high");
            });

            updateSectionVisibility();
        });
    </script>
</body>

</html>