<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Админ-панель: сервисы</title>
    {% include 'partials/base_header.html' %}
    <link rel="stylesheet" href="{{ 'profile.css' | ver }}">
    <style>
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: .6rem 1rem;
        }
    </style>
</head>

<body>
    <div class="page-background" style="background-image: url('/static/images/wallpaper.jpeg');">
        {% include 'partials/header.html' %}

        <main class="content-tile" style="max-width:1100px;">
            <h1 class="welcome-title">Сервисы / Товары</h1>

            <section>
                <h2>Добавить сервис</h2>
                <form method="post" action="/profile/admin/service/create" class="create-form">
                    <input type="text" name="name" placeholder="Название" required>
                    <input type="text" name="description" placeholder="Описание">
                    <input type="text" name="price_main" placeholder="Цена" required>
                    <input type="number" name="discount_value" placeholder="Скидка (%)" min="0" max="100">
                    <input type="datetime-local" name="discount_date" placeholder="Дата конца скидки">
                    <select name="status">
                        <option value="on">Вкл</option>
                        <option value="off" selected>Выкл</option>
                        <option value="archive">Архив</option>
                    </select>
                    <input type="number" name="left" placeholder="Остаток">
                    <input type="datetime-local" name="sell_time" placeholder="Время продажи">
                    <label><input type="checkbox" name="oferta_limit"> Ограничение оферты</label>
                    <button class="btn" type="submit">Создать</button>
                </form>
            </section>

            {% if not services %}
            <p>Пока нет сервисов.</p>
            {% else %}
            <div class="players-grid" id="services">
                {% for s in services %}
                <div class="player-card" data-service='{{ s | tojson }}'>
                    <div class="player-header">
                        <div class="player-name">{{ s.name }}</div>
                    </div>
                    <div class="muted">Цена: {{ s.price_main }} (итог: {{ s.final_price }})</div>
                    <div class="badges">
                        <span class="badge">{{ s.status }}</span>
                        {% if s.discount_value and s.discount_value > 0 %}
                        <span class="badge">-{{ s.discount_value }}%</span>
                        {% endif %}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-edit" type="button">Изменить</button>
                        <form method="post" action="/profile/admin/service/delete"
                            onsubmit="return confirm('Удалить {{ s.name }}?');" style="display:inline;">
                            <input type="hidden" name="u_id" value="{{ s.u_id }}">
                            <button class="btn danger" type="submit">Удалить</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </main>
    </div>

    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h2 id="modal-title">Редактировать сервис</h2>
            <form id="edit-form" method="post" action="/profile/admin/service/update">
                <input type="hidden" name="u_id" id="f_id">

                <fieldset class="fieldset">
                    <legend>Основное</legend>
                    <div class="form-grid">
                        <label>Название<input type="text" name="name" id="f_name" required></label>
                        <label>Описание<input type="text" name="description" id="f_desc"></label>
                        <label>Цена<input type="text" name="price_main" id="f_price"></label>
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Скидки</legend>
                    <div class="form-grid">
                        <label>Скидка (%)<input type="number" name="discount_value" id="f_discount" min="0"
                                max="100"></label>
                        <label>Дата конца скидки<input type="datetime-local" name="discount_date"
                                id="f_discdate"></label>
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Прочее</legend>
                    <div class="form-grid">
                        <label>Статус
                            <select name="status" id="f_status">
                                <option value="on">Вкл</option>
                                <option value="off">Выкл</option>
                                <option value="archive">Архив</option>
                            </select>
                        </label>
                        <label>Остаток<input type="number" name="left" id="f_left"></label>
                        <label>Время продажи<input type="datetime-local" name="sell_time" id="f_sell"></label>
                    </div>
                    <label style="margin-top:.6rem;display:block;">
                        <input type="checkbox" name="oferta_limit" id="f_oferta"> Ограничение оферты
                    </label>
                </fieldset>

                <div class="modal-actions">
                    <button class="btn" type="button" id="btn-cancel">Отмена</button>
                    <button class="btn" type="submit">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            const grid = document.getElementById('services');
            const backdrop = document.getElementById('modal-backdrop');
            const f_id = document.getElementById('f_id'),
                f_name = document.getElementById('f_name'),
                f_desc = document.getElementById('f_desc'),
                f_price = document.getElementById('f_price'),
                f_discount = document.getElementById('f_discount'),
                f_discdate = document.getElementById('f_discdate'),
                f_status = document.getElementById('f_status'),
                f_left = document.getElementById('f_left'),
                f_sell = document.getElementById('f_sell'),
                f_oferta = document.getElementById('f_oferta');

            function isoToLocal(dtStr) {
                if (!dtStr) return "";
                const dt = new Date(dtStr);
                return dt.toISOString().slice(0, 16);
            }

            function openModal(card) {
                const s = JSON.parse(card.dataset.service);
                f_id.value = s.u_id;
                f_name.value = s.name || '';
                f_desc.value = s.description || '';
                f_price.value = s.price_main || '';
                f_discount.value = s.discount_value || 0;
                f_discdate.value = isoToLocal(s.discount_date);
                f_status.value = s.status || 'off';
                f_left.value = s.left || '';
                f_sell.value = isoToLocal(s.sell_time);
                f_oferta.checked = !!s.oferta_limit;
                backdrop.style.display = 'flex';
            }

            function closeModal() { backdrop.style.display = 'none'; }

            if (grid) {
                grid.addEventListener('click', e => {
                    const btn = e.target.closest('.btn-edit');
                    if (btn) openModal(btn.closest('.player-card'));
                });
            }

            document.getElementById('btn-cancel').addEventListener('click', e => {
                e.preventDefault(); closeModal();
            });

            backdrop.addEventListener('click', e => {
                if (e.target === backdrop) closeModal();
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') closeModal();
            });
        })();
    </script>
</body>

</html>