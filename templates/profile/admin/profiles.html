<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Админ-панель: профили игроков</title>
    <meta property="og:title" content="S.P.F. Base – Профили игроков">
    <meta property="og:description" content="Просмотр и управление профилями">

    {% include 'partials/base_header.html' %}
    <link rel="stylesheet" href="{{ 'profile.css' | ver }}">
</head>

<body>
    <div class="page-background" style="background-image: url('/static/images/wallpaper.jpeg');">
        {% include 'partials/header.html' %}
        <main class="content-tile" style="max-width:1100px;">
            <h1 class="welcome-title">Профили игроков</h1>

            <form method="get" action="/profile/admin/profiles">
                <input type="text" name="q" placeholder="Поиск: Имя / UUID / Discord / Steam" value="{{ q or '' }}"
                    style="width:min(520px,90%);padding:.55rem;border-radius:8px;border:1px solid #666;background:#111;color:#eee;">
                <button class="btn" type="submit">Искать</button>
            </form>

            <section style="margin-top:1rem;">
                <h2 class="welcome-title" style="margin-bottom:.4rem;">Добавить игрока</h2>
                <form method="post" action="/profile/admin/profile/create" class="create-form">
                    <input type="text" name="discord_id" placeholder="Discord ID" pattern="\d{5,}" required>
                    <input type="text" name="steam_input" placeholder="Steam ссылка / ID" required>
                    <button class="btn" type="submit">Создать профиль</button>
                </form>
            </section>

            <section style="margin-top:1rem;">
                <h2 class="welcome-title" style="margin-bottom:.4rem;">Массовые действия</h2>
                <form method="post" action="/profile/admin/recalc_weights" style="margin-bottom:.5rem;">
                    <button class="btn" type="submit"
                        onclick="return confirm('Пересчитать вес контента у всех игроков? Это может занять время.');">
                        Обновить вес по всему контенту
                    </button>
                </form>
                <form method="post" action="/profile/admin/recalc_roles">
                    <button class="btn" type="submit"
                        onclick="return confirm('Обновить лимиты ролей Discord у всех игроков?');">
                        Обновить роли у всех игроков
                    </button>
                </form>
            </section>

            {% if not users %}
            <p>Пока пусто.</p>
            {% else %}
            <div class="players-grid" id="players">
                {% for u in users %}
                <div class="player-card" data-profile='{{ {
                     "uuid": u.uuid,
                     "username": u.username,
                     "discord": u.discord_id,
                     "steam": u.steam_id,
                     "avatar_url": u.avatar_url or "/static/images/logo/discord.png",
                     "access": u.access,
                     "blacklist": u.blacklist,
                     "limits": u.limits,
                     "notes": u.notes or [],
                     "chars": u.chars or []
                 } | tojson }}'>
                    <div class="player-header">
                        <img src="{{ u.avatar_url or '/static/images/logo/discord.png' }}" alt="avatar">
                        <div class="player-name">{{ u.username }}</div>
                    </div>
                    <div class="badges">
                        {% if u.access.panel_access %}<span class="badge admin">Админ-панель</span>{% endif %}
                        {% if u.access.full_access %}<span class="badge admin">Full</span>{% endif %}
                        {% if u.has_blacklist %}<span class="badge blacklist">ЧС</span>{% endif %}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-edit" type="button">Изменить</button>
                        <form method="post" action="/profile/admin/profile/delete"
                            onsubmit="return confirm('Удалить профиль? Это необратимо.');" style="display:inline;">
                            <input type="hidden" name="uuid" value="{{ u.uuid }}">
                            <button class="btn danger" type="submit">Удалить</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </main>
    </div>

    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-player-name">
            <h2 id="modal-player-name">Игрок</h2>

            <div class="id-block">
                <div class="id-row">
                    <div class="k muted">UUID</div>
                    <div class="v"><span id="m_uuid" class="mono"></span></div>
                </div>
                <div class="id-row">
                    <div class="k muted">Discord ID</div>
                    <div class="v"><span id="m_discord" class="mono"></span></div>
                </div>
                <div class="id-row">
                    <div class="k muted">Steam ID</div>
                    <div class="v"><span id="m_steam" class="mono"></span></div>
                </div>
            </div>

            <form id="edit-form" method="post" action="/profile/admin/profile/update">
                <input type="hidden" name="uuid" id="f_uuid">

                <fieldset class="fieldset">
                    <legend>Права</legend>
                    <div class="checkboxes">
                        {% for key, label in ACCESS_FIELDS.items() %}
                        <label><input type="checkbox" name="access_{{ key }}" id="f_acc_{{ key }}">{{ label }}</label>
                        {% endfor %}
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Чёрные списки</legend>
                    <div class="checkboxes">
                        {% for key, label in BLACKLIST_FIELDS.items() %}
                        <label><input type="checkbox" name="blacklist_{{ key }}" id="f_bl_{{ key }}">{{ label }}</label>
                        {% endfor %}
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Лимиты</legend>
                    <div class="form-grid">
                        <label>Место (MB)<input type="number" name="base_limit" id="f_lim_base" min="0"
                                step="0.01"></label>
                        <label>Донат место (MB)<input type="number" name="donate_limit" id="f_lim_donate" min="0"
                                step="0.01"></label>
                        <label>Использовано (MB)<input type="number" name="used" id="f_lim_used" min="0"
                                step="0.01"></label>
                        <label>Базовые персонажи<input type="number" name="base_char" id="f_lim_basechar"
                                min="0"></label>
                        <label>Донат персонажи<input type="number" name="donate_char" id="f_lim_donatechar"
                                min="0"></label>
                    </div>
                </fieldset>

                <div class="modal-actions">
                    <button class="btn" type="button" id="btn-cancel">Отмена</button>
                    <button class="btn" type="submit">Сохранить</button>
                </div>
            </form>

            <fieldset class="fieldset">
                <legend>Персонажи</legend>
                <ul class="read-list" id="char_list"></ul>
                <form id="char-form" method="post" action="/profile/admin/char/add">
                    <input type="hidden" name="uuid" id="c_uuid">
                    <input type="text" name="name" placeholder="Имя персонажа" required>
                    <input type="text" name="discord_url" placeholder="Ссылка на анкету (Discord)">
                    <textarea name="steam_urls" placeholder="Ссылки на контент (Steam), по одной в строке"></textarea>
                    <button class="btn" type="submit">Добавить</button>
                </form>
            </fieldset>

            <fieldset class="fieldset">
                <legend>Заметки</legend>
                <ul class="read-list" id="note_list"></ul>
                <form id="note-form" method="post" action="/profile/admin/note/add">
                    <input type="hidden" name="uuid" id="n_uuid">
                    <select name="status">
                        <option value="info">info</option>
                        <option value="warn">warn</option>
                        <option value="ban">ban</option>
                    </select>
                    <textarea name="content" required placeholder="Текст заметки"></textarea>
                    <button class="btn" type="submit">Добавить</button>
                </form>
            </fieldset>
        </div>
    </div>

    <script>
        (function () {
            function createCardNode(view) {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.dataset.profile = JSON.stringify({
                    uuid: view.uuid,
                    username: view.username,
                    discord: view.discord_id,
                    steam: view.steam_id,
                    avatar_url: view.avatar_url || '/static/images/logo/discord.png',
                    access: view.access || {},
                    blacklist: view.blacklist || {},
                    limits: view.limits || {},
                    notes: view.notes || [],
                    chars: view.chars || []
                });

                div.innerHTML = `
            <div class="player-header">
                <img src="${escapeHtml(view.avatar_url || '/static/images/logo/discord.png')}" alt="avatar">
                <div class="player-name">${escapeHtml(view.username || 'Без имени')}</div>
            </div>
            <div class="badges">
                ${view.access && view.access.panel_access ? '<span class="badge admin">Админ-панель</span>' : ''}
                ${view.access && view.access.full_access ? '<span class="badge admin">Full</span>' : ''}
                ${view.has_blacklist ? '<span class="badge blacklist">ЧС</span>' : ''}
            </div>
            <div class="card-actions">
                <button class="btn btn-edit" type="button">Изменить</button>
                <form method="post" action="/profile/admin/profile/delete" onsubmit="return confirm('Удалить профиль? Это необратимо.');" style="display:inline;">
                    <input type="hidden" name="uuid" value="${escapeHtml(view.uuid || '')}">
                    <button class="btn danger" type="submit">Удалить</button>
                </form>
            </div>
        `;
                return div;
            }

            function escapeHtml(s) {
                if (s == null) return '';
                return String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            async function consumeStream() {
                const players = document.getElementById('players');
                if (!players) return;

                const params = new URLSearchParams(window.location.search);
                const q = params.get('q');
                const url = '/profile/admin/profiles/stream' + (q ? '?q=' + encodeURIComponent(q) : '');

                try {
                    const res = await fetch(url);
                    if (!res.body) return;
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buf = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buf += decoder.decode(value, { stream: true });
                        let idx;
                        while ((idx = buf.indexOf('\n')) >= 0) {
                            const line = buf.slice(0, idx).trim();
                            buf = buf.slice(idx + 1);
                            if (!line) continue;
                            try {
                                const obj = JSON.parse(line);
                                const existing = Array.from(players.children).find(
                                    c => c.dataset.profile && JSON.parse(c.dataset.profile).uuid === obj.uuid
                                );
                                if (existing) {
                                    const img = existing.querySelector('.player-header img');
                                    const name = existing.querySelector('.player-name');
                                    if (img && obj.avatar_url) img.src = obj.avatar_url;
                                    if (name && obj.username) name.textContent = obj.username;
                                    existing.dataset.profile = JSON.stringify({
                                        uuid: obj.uuid,
                                        username: obj.username,
                                        discord: obj.discord_id,
                                        steam: obj.steam_id,
                                        avatar_url: obj.avatar_url || '/static/images/logo/discord.png',
                                        access: obj.access || {},
                                        blacklist: obj.blacklist || {},
                                        limits: obj.limits || {},
                                        notes: obj.notes || [],
                                        chars: obj.chars || []
                                    });
                                } else {
                                    const node = createCardNode(obj);
                                    players.appendChild(node);
                                }
                            } catch (e) {
                                console.warn('Malformed stream line', e);
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Profile stream failed', e);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', consumeStream);
            } else {
                consumeStream();
            }
        })();
    </script>
</body>

</html>