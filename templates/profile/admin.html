<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Админ-панель: список игроков</title>
    <meta property="og:title" content="S.P.F. Base – Список игроков">
    <meta property="og:description" content="Просмотр всех профилей">

    {% include 'partials/base_header.html' %}
    <link rel="stylesheet" href="{{ 'profile.css' | ver }}">
</head>

<body>
    <div class="page-background" style="background-image: url('/static/images/wallpaper.jpeg');">
        {% include 'partials/header.html' %}
        <main class="content-tile" style="max-width:1100px;">
            <h1 class="welcome-title">Список игроков</h1>

            <form method="get" action="/profile/admin">
                <input type="text" name="q" placeholder="Поиск: Имя / UUID / Discord / Steam" value="{{ q or '' }}"
                    style="width:min(520px,90%);padding:.55rem;border-radius:8px;border:1px solid #666;background:#111;color:#eee;">
                <button class="btn" type="submit">Искать</button>
            </form>

            <section style="margin-top:1rem;">
                <h2 class="welcome-title" style="margin-bottom:.4rem;">Добавить игрока</h2>
                <form method="post" action="/profile/admin/create" class="create-form">
                    <input type="text" name="discord_id" placeholder="Discord ID" pattern="\d{5,}" required>
                    <input type="text" name="steam" placeholder="Steam" required>
                    <button class="btn" type="submit">Создать профиль</button>
                </form>
            </section>

            <section style="margin-top:1rem;">
                <h2 class="welcome-title" style="margin-bottom:.4rem;">Массовые действия</h2>
                <form method="post" action="/profile/admin/recalc_weights" style="margin-bottom:.5rem;">
                    <button class="btn" type="submit"
                        onclick="return confirm('Пересчитать вес контента у всех игроков? Это может занять время.');">
                        Обновить вес по всему контенту
                    </button>
                </form>
                <form method="post" action="/profile/admin/recalc_roles">
                    <button class="btn" type="submit"
                        onclick="return confirm('Обновить лимиты ролей Discord у всех игроков?');">
                        Обновить роли у всех игроков
                    </button>
                </form>
            </section>

            {% if not users or users|length == 0 %}
            <p>Пока пусто.</p>
            {% else %}
            <div class="players-grid" id="players">
                {% for u in users %}
                <div class="player-card" data-uuid="{{ u.uuid }}" data-username="{{ u.username|e }}"
                    data-discord="{{ u.discord_id or '' }}" data-steam="{{ u.steam_id or '' }}"
                    data-is-admin="{{ '1' if u.is_admin else '0' }}"
                    data-bl-chars="{{ '1' if u.blacklist.chars else '0' }}"
                    data-bl-lore="{{ '1' if u.blacklist.lore_chars else '0' }}"
                    data-bl-admin="{{ '1' if u.blacklist.admin else '0' }}" data-lim-base="{{ u.limits.base_limit }}"
                    data-lim-donate="{{ u.limits.donate_limit }}"
                    data-lim-used="{{ u.limits.used if u.limits.used is not none else 0 }}"
                    data-lim-basechar="{{ u.limits.base_char }}" data-lim-donatechar="{{ u.limits.donate_char }}"
                    data-notes='{{ u.notes|tojson if u.notes else "[]" }}'
                    data-chars='{{ u.chars|tojson if u.chars else "[]" }}'>
                    <div class="player-header">
                        <img src="{{ u.avatar_url or '/static/images/logo/discord.png' }}" alt="avatar">
                        <div class="player-name">{{ u.username }}</div>
                    </div>
                    <div class="badges">
                        {% if u.is_admin %}<span class="badge admin">Администратор</span>{% endif %}
                        {% if u.has_blacklist %}<span class="badge blacklist">ЧС</span>{% endif %}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-edit" type="button">Изменить</button>
                        <form method="post" action="/profile/admin/delete"
                            onsubmit="return confirm('Удалить профиль? Это необратимо.');" style="display:inline;">
                            <input type="hidden" name="uuid" value="{{ u.uuid }}">
                            <button class="btn danger" type="submit">Удалить</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </main>
    </div>

    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-player-name">
            <h2 id="modal-player-name">Игрок</h2>

            <div class="id-block">
                <div class="id-row">
                    <div class="k muted">UUID</div>
                    <div class="v"><span id="modal-uuid" class="mono"></span></div>
                    <div><button type="button" class="btn copy-btn" data-copy="#modal-uuid">Копировать</button></div>
                </div>
                <div class="id-row">
                    <div class="k muted">Discord ID</div>
                    <div class="v"><span id="modal-discord" class="mono"></span></div>
                    <div><button type="button" class="btn copy-btn" data-copy="#modal-discord">Копировать</button></div>
                </div>
                <div class="id-row">
                    <div class="k muted">Steam ID</div>
                    <div class="v"><span id="modal-steam" class="mono"></span></div>
                    <div><button type="button" class="btn copy-btn" data-copy="#modal-steam">Копировать</button></div>
                </div>
            </div>

            <form id="edit-form" method="post" action="/profile/admin/update">
                <input type="hidden" name="uuid" id="f_uuid">

                <fieldset class="fieldset">
                    <legend>Права и ограничения</legend>
                    <div class="checkboxes">
                        <label><input type="checkbox" name="is_admin" id="f_is_admin"> Администратор</label>
                        <label><input type="checkbox" name="blacklist_chars" id="f_bl_chars"> ЧС: новые
                            персонажи</label>
                        <label><input type="checkbox" name="blacklist_lore" id="f_bl_lore"> ЧС: лорные персонажи</label>
                        <label><input type="checkbox" name="blacklist_admin" id="f_bl_admin"> ЧС: администрация</label>
                    </div>
                </fieldset>

                <fieldset class="fieldset">
                    <legend>Лимиты</legend>
                    <div class="form-grid">
                        <label>Место (MB)
                            <input type="number" name="base_limit" id="f_lim_base" min="0" step="0.01">
                        </label>
                        <label>Донат место (MB)
                            <input type="number" name="donate_limit" id="f_lim_donate" min="0" step="0.01">
                        </label>
                        <label>Использовано (MB)
                            <input type="number" name="used" id="f_lim_used" min="0" step="0.01">
                        </label>
                        <label>Базовые персонажи
                            <input type="number" name="base_char" id="f_lim_basechar" min="0" step="1">
                        </label>
                        <label>Донат персонажи
                            <input type="number" name="donate_char" id="f_lim_donatechar" min="0" step="1">
                        </label>
                    </div>
                </fieldset>

                <div class="modal-actions">
                    <button class="btn" type="button" id="btn-cancel">Отмена</button>
                    <button class="btn" type="submit">Сохранить</button>
                </div>
            </form>

            <fieldset class="fieldset">
                <legend>Персонажи</legend>
                <ul class="read-list" id="f_char_list"></ul>
                <div class="muted">Список текущих персонажей.
                </div>

                <form id="char-form" method="post" action="/profile/admin/char/add">
                    <input type="hidden" name="uuid" id="c_uuid">
                    <div class="form-grid">
                        <label>Имя персонажа
                            <input type="text" name="name" required>
                        </label>
                        <label>Ссылка на анкету (Discord)
                            <input type="text" name="discord_url"
                                placeholder="https://discord.com/channels/.../message_id">
                        </label>
                        <label style="grid-column: 1 / -1;">Ссылки на контент (Steam), по одной в строке
                            <textarea name="steam_urls"></textarea>
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button class="btn" type="submit">Добавить персонажа</button>
                    </div>
                </form>
            </fieldset>

            <fieldset class="fieldset">
                <legend>Заметки</legend>
                <ul class="read-list" id="f_note_list"></ul>
                <div class="muted">Новая заметка:</div>

                <form id="note-form" method="post" action="/profile/admin/note/add">
                    <input type="hidden" name="uuid" id="n_uuid">
                    <div class="form-grid">
                        <label>Статус
                            <select name="status">
                                <option value="info">info</option>
                                <option value="warn">warn</option>
                                <option value="ban">ban</option>
                            </select>
                        </label>
                        <label style="grid-column: 1 / -1;">Текст
                            <textarea name="content" required></textarea>
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button class="btn" type="submit">Добавить заметку</button>
                    </div>
                </form>
            </fieldset>
        </div>
    </div>

    <script>
        (function () {
            const grid = document.getElementById('players');
            const backdrop = document.getElementById('modal-backdrop');

            const modalName = document.getElementById('modal-player-name');
            const modalUuid = document.getElementById('modal-uuid');
            const modalDiscord = document.getElementById('modal-discord');
            const modalSteam = document.getElementById('modal-steam');

            const f_uuid = document.getElementById('f_uuid');
            const f_is_admin = document.getElementById('f_is_admin');
            const f_bl_chars = document.getElementById('f_bl_chars');
            const f_bl_lore = document.getElementById('f_bl_lore');
            const f_bl_admin = document.getElementById('f_bl_admin');

            const f_lim_base = document.getElementById('f_lim_base');
            const f_lim_donate = document.getElementById('f_lim_donate');
            const f_lim_used = document.getElementById('f_lim_used');
            const f_lim_basechar = document.getElementById('f_lim_basechar');
            const f_lim_donatechar = document.getElementById('f_lim_donatechar');

            const charList = document.getElementById('f_char_list');
            const noteList = document.getElementById('f_note_list');

            function openModal(card) {
                modalName.textContent = card.dataset.username || 'Без имени';

                const uuid = card.dataset.uuid || '-';
                modalUuid.textContent = uuid;
                modalDiscord.textContent = card.dataset.discord || '-';
                modalSteam.textContent = card.dataset.steam || '-';

                f_uuid.value = uuid;
                const cUuid = document.getElementById('c_uuid');
                const nUuid = document.getElementById('n_uuid');
                if (cUuid) cUuid.value = uuid;
                if (nUuid) nUuid.value = uuid;

                f_is_admin.checked = card.dataset.isAdmin === '1';
                f_bl_chars.checked = card.dataset.blChars === '1';
                f_bl_lore.checked = card.dataset.blLore === '1';
                f_bl_admin.checked = card.dataset.blAdmin === '1';

                f_lim_base.value = card.dataset.limBase || 0;
                f_lim_donate.value = card.dataset.limDonate || 0;
                f_lim_used.value = card.dataset.limUsed || 0;
                f_lim_basechar.value = card.dataset.limBasechar || 0;
                f_lim_donatechar.value = card.dataset.limDonatechar || 0;

                noteList.innerHTML = '';
                try {
                    const notes = JSON.parse(card.dataset.notes || '[]');
                    notes.forEach(n => {
                        const li = document.createElement('li');
                        li.textContent = `[${n.date}] (${n.status}) ${n.content}`;
                        noteList.appendChild(li);
                    });
                } catch (e) { console.error(e); }

                charList.innerHTML = '';
                try {
                    const chars = JSON.parse(card.dataset.chars || '[]');
                    chars.forEach((c, i) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${c.name}</strong>` +
                            (c.discord_url ? ` - <a href="${c.discord_url}" target="_blank" rel="noopener noreferrer">анкета</a>` : '');
                        if (Array.isArray(c.steam_urls) && c.steam_urls.length) {
                            li.innerHTML += '<br>Контент: ' +
                                c.steam_urls.map(s => `<a href="${s}" target="_blank" rel="noopener noreferrer">link</a>`).join(', ');
                        }
                        li.innerHTML += `
                        <form method="post" action="/profile/admin/char/delete" style="margin-top:.3rem;"
                            onsubmit="return confirm('Удалить персонажа «${c.name}»?');">
                            <input type="hidden" name="uuid" value="${uuid}">
                            <input type="hidden" name="index" value="${i}">
                            <button class="btn danger" type="submit">Удалить</button>
                        </form>`;
                        charList.appendChild(li);
                    });
                } catch (e) { console.error(e); }

                backdrop.style.display = 'flex';
            }

            function closeModal() { backdrop.style.display = 'none'; }

            document.addEventListener('click', e => {
                const edit = e.target.closest('.btn-edit');
                if (edit) openModal(edit.closest('.player-card'));
            });
            document.getElementById('btn-cancel').addEventListener('click', e => { e.preventDefault(); closeModal(); });
            backdrop.addEventListener('click', e => { if (e.target === backdrop) closeModal(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

            document.addEventListener('click', e => {
                const btn = e.target.closest('.copy-btn');
                if (!btn) return;
                const sel = btn.getAttribute('data-copy');
                const el = document.querySelector(sel);
                if (!el) return;
                navigator.clipboard.writeText(el.textContent.trim()).catch(() => { });
            });

            const qInput = document.querySelector('input[name="q"]');
            if (qInput && grid) {
                qInput.addEventListener('input', () => {
                    const q = qInput.value.trim().toLowerCase();
                    grid.querySelectorAll('.player-card').forEach(card => {
                        const hay = [
                            card.dataset.username || '',
                            card.dataset.uuid || '',
                            card.dataset.discord || '',
                            card.dataset.steam || ''
                        ].join(' ').toLowerCase();
                        card.style.display = hay.includes(q) ? '' : 'none';
                    });
                });
            }
        })();
    </script>
</body>

</html>